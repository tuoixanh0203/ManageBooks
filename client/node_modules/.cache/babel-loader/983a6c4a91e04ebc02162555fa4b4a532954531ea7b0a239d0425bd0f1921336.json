{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ApolloServerPluginInlineTraceDisabled = exports.ApolloServerPluginInlineTrace = void 0;\nconst apollo_reporting_protobuf_1 = require(\"apollo-reporting-protobuf\");\nconst traceTreeBuilder_1 = require(\"../traceTreeBuilder\");\nconst schemaIsFederated_1 = require(\"../schemaIsFederated\");\nfunction ApolloServerPluginInlineTrace() {\n  let options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : Object.create(null);\n  let enabled = options.__onlyIfSchemaIsFederated ? null : true;\n  return {\n    __internal_plugin_id__() {\n      return 'InlineTrace';\n    },\n    async serverWillStart(_ref) {\n      let {\n        schema,\n        logger\n      } = _ref;\n      if (enabled === null) {\n        enabled = (0, schemaIsFederated_1.schemaIsFederated)(schema);\n        if (enabled) {\n          logger.info('Enabling inline tracing for this federated service. To disable, use ' + 'ApolloServerPluginInlineTraceDisabled.');\n        }\n      }\n    },\n    async requestDidStart(_ref2) {\n      let {\n        request: {\n          http\n        },\n        metrics\n      } = _ref2;\n      if (!enabled) {\n        return;\n      }\n      const treeBuilder = new traceTreeBuilder_1.TraceTreeBuilder({\n        rewriteError: options.rewriteError\n      });\n      if ((http === null || http === void 0 ? void 0 : http.headers.get('apollo-federation-include-trace')) !== 'ftv1') {\n        return;\n      }\n      if (metrics.captureTraces === false) {\n        return;\n      }\n      metrics.captureTraces = true;\n      treeBuilder.startTiming();\n      return {\n        async executionDidStart() {\n          return {\n            willResolveField(_ref3) {\n              let {\n                info\n              } = _ref3;\n              return treeBuilder.willResolveField(info);\n            }\n          };\n        },\n        async didEncounterErrors(_ref4) {\n          let {\n            errors\n          } = _ref4;\n          treeBuilder.didEncounterErrors(errors);\n        },\n        async willSendResponse(_ref5) {\n          let {\n            response\n          } = _ref5;\n          treeBuilder.stopTiming();\n          if (metrics.queryPlanTrace) {\n            treeBuilder.trace.queryPlan = metrics.queryPlanTrace;\n          }\n          const encodedUint8Array = apollo_reporting_protobuf_1.Trace.encode(treeBuilder.trace).finish();\n          const encodedBuffer = Buffer.from(encodedUint8Array, encodedUint8Array.byteOffset, encodedUint8Array.byteLength);\n          const extensions = response.extensions || (response.extensions = Object.create(null));\n          if (typeof extensions.ftv1 !== 'undefined') {\n            throw new Error('The `ftv1` extension was already present.');\n          }\n          extensions.ftv1 = encodedBuffer.toString('base64');\n        }\n      };\n    }\n  };\n}\nexports.ApolloServerPluginInlineTrace = ApolloServerPluginInlineTrace;\nfunction ApolloServerPluginInlineTraceDisabled() {\n  return {\n    __internal_plugin_id__() {\n      return 'InlineTrace';\n    }\n  };\n}\nexports.ApolloServerPluginInlineTraceDisabled = ApolloServerPluginInlineTraceDisabled;","map":{"version":3,"mappings":";;;;;;AAAA;AACA;AAGA;AA4BA,SAAgBA,6BAA6B,GACwB;EAAA,IAAnEC,8EAAgDC,MAAM,CAACC,MAAM,CAAC,IAAI,CAAC;EAEnE,IAAIC,OAAO,GAAmBH,OAAO,CAACI,yBAAyB,GAAG,IAAI,GAAG,IAAI;EAC7E,OAAO;IACLC,sBAAsB;MACpB,OAAO,aAAa;IACtB,CAAC;IACD,MAAMC,eAAe,OAAmB;MAAA,IAAlB;QAAEC,MAAM;QAAEC;MAAM,CAAE;MAKtC,IAAIL,OAAO,KAAK,IAAI,EAAE;QACpBA,OAAO,GAAG,yCAAiB,EAACI,MAAM,CAAC;QACnC,IAAIJ,OAAO,EAAE;UACXK,MAAM,CAACC,IAAI,CACT,sEAAsE,GACpE,wCAAwC,CAC3C;;;IAGP,CAAC;IACD,MAAMC,eAAe,QAA+B;MAAA,IAA9B;QAAEC,OAAO,EAAE;UAAEC;QAAI,CAAE;QAAEC;MAAO,CAAE;MAClD,IAAI,CAACV,OAAO,EAAE;QACZ;;MAGF,MAAMW,WAAW,GAAG,IAAIC,mCAAgB,CAAC;QACvCC,YAAY,EAAEhB,OAAO,CAACgB;OACvB,CAAC;MAGF,IAAI,KAAI,aAAJJ,IAAI,uBAAJA,IAAI,CAAEK,OAAO,CAACC,GAAG,CAAC,iCAAiC,CAAC,MAAK,MAAM,EAAE;QACnE;;MAKF,IAAIL,OAAO,CAACM,aAAa,KAAK,KAAK,EAAE;QACnC;;MAMFN,OAAO,CAACM,aAAa,GAAG,IAAI;MAE5BL,WAAW,CAACM,WAAW,EAAE;MAEzB,OAAO;QACL,MAAMC,iBAAiB;UACrB,OAAO;YACLC,gBAAgB,QAAS;cAAA,IAAR;gBAAEb;cAAI,CAAE;cACvB,OAAOK,WAAW,CAACQ,gBAAgB,CAACb,IAAI,CAAC;YAC3C;WACD;QACH,CAAC;QAED,MAAMc,kBAAkB,QAAW;UAAA,IAAV;YAAEC;UAAM,CAAE;UACjCV,WAAW,CAACS,kBAAkB,CAACC,MAAM,CAAC;QACxC,CAAC;QAED,MAAMC,gBAAgB,QAAa;UAAA,IAAZ;YAAEC;UAAQ,CAAE;UAGjCZ,WAAW,CAACa,UAAU,EAAE;UAMxB,IAAId,OAAO,CAACe,cAAc,EAAE;YAC1Bd,WAAW,CAACe,KAAK,CAACC,SAAS,GAAGjB,OAAO,CAACe,cAAc;;UAGtD,MAAMG,iBAAiB,GAAGC,iCAAK,CAACC,MAAM,CAACnB,WAAW,CAACe,KAAK,CAAC,CAACK,MAAM,EAAE;UAClE,MAAMC,aAAa,GAAGC,MAAM,CAACC,IAAI,CAC/BN,iBAAiB,EACjBA,iBAAiB,CAACO,UAAU,EAC5BP,iBAAiB,CAACQ,UAAU,CAC7B;UAED,MAAMC,UAAU,GACdd,QAAQ,CAACc,UAAU,KAAKd,QAAQ,CAACc,UAAU,GAAGvC,MAAM,CAACC,MAAM,CAAC,IAAI,CAAC,CAAC;UAIpE,IAAI,OAAOsC,UAAU,CAACC,IAAI,KAAK,WAAW,EAAE;YAC1C,MAAM,IAAIC,KAAK,CAAC,2CAA2C,CAAC;;UAG9DF,UAAU,CAACC,IAAI,GAAGN,aAAa,CAACQ,QAAQ,CAAC,QAAQ,CAAC;QACpD;OACD;IACH;GACD;AACH;AAjGAC;AAqGA,SAAgBC,qCAAqC;EACnD,OAAO;IACLxC,sBAAsB;MACpB,OAAO,aAAa;IACtB;GACD;AACH;AANAuC","names":["ApolloServerPluginInlineTrace","options","Object","create","enabled","__onlyIfSchemaIsFederated","__internal_plugin_id__","serverWillStart","schema","logger","info","requestDidStart","request","http","metrics","treeBuilder","traceTreeBuilder_1","rewriteError","headers","get","captureTraces","startTiming","executionDidStart","willResolveField","didEncounterErrors","errors","willSendResponse","response","stopTiming","queryPlanTrace","trace","queryPlan","encodedUint8Array","apollo_reporting_protobuf_1","encode","finish","encodedBuffer","Buffer","from","byteOffset","byteLength","extensions","ftv1","Error","toString","exports","ApolloServerPluginInlineTraceDisabled"],"sources":["C:\\Users\\Admin\\Documents\\Web\\GRAPHQL\\node_modules\\apollo-server-core\\src\\plugin\\inlineTrace\\index.ts"],"sourcesContent":["import { Trace } from 'apollo-reporting-protobuf';\nimport { TraceTreeBuilder } from '../traceTreeBuilder';\nimport type { ApolloServerPluginUsageReportingOptions } from '../usageReporting/options';\nimport type { InternalApolloServerPlugin } from '../../internalPlugin';\nimport { schemaIsFederated } from '../schemaIsFederated';\n\nexport interface ApolloServerPluginInlineTraceOptions {\n  /**\n   * By default, all errors from this service get included in the trace.  You\n   * can specify a filter function to exclude specific errors from being\n   * reported by returning an explicit `null`, or you can mask certain details\n   * of the error by modifying it and returning the modified error.\n   */\n  rewriteError?: ApolloServerPluginUsageReportingOptions<never>['rewriteError'];\n  /**\n   * This option is for internal use by `apollo-server-core` only.\n   *\n   * By default we want to enable this plugin for federated schemas only, but we\n   * need to come up with our list of plugins before we have necessarily loaded\n   * the schema. So (unless the user installs this plugin or\n   * ApolloServerPluginInlineTraceDisabled themselves), `apollo-server-core`\n   * always installs this plugin and uses this option to make sure traces are\n   * only included if the schema appears to be federated.\n   */\n  __onlyIfSchemaIsFederated?: boolean;\n}\n\n// This ftv1 plugin produces a base64'd Trace protobuf containing only the\n// durationNs, startTime, endTime, and root fields.  This output is placed\n// on the `extensions`.`ftv1` property of the response.  The Apollo Gateway\n// utilizes this data to construct the full trace and submit it to Apollo's\n// usage reporting ingress.\nexport function ApolloServerPluginInlineTrace(\n  options: ApolloServerPluginInlineTraceOptions = Object.create(null),\n): InternalApolloServerPlugin {\n  let enabled: boolean | null = options.__onlyIfSchemaIsFederated ? null : true;\n  return {\n    __internal_plugin_id__() {\n      return 'InlineTrace';\n    },\n    async serverWillStart({ schema, logger }) {\n      // Handle the case that the plugin was implicitly installed. We only want it\n      // to actually be active if the schema appears to be federated. If you don't\n      // like the log line, just install `ApolloServerPluginInlineTrace()` in\n      // `plugins` yourself.\n      if (enabled === null) {\n        enabled = schemaIsFederated(schema);\n        if (enabled) {\n          logger.info(\n            'Enabling inline tracing for this federated service. To disable, use ' +\n              'ApolloServerPluginInlineTraceDisabled.',\n          );\n        }\n      }\n    },\n    async requestDidStart({ request: { http }, metrics }) {\n      if (!enabled) {\n        return;\n      }\n\n      const treeBuilder = new TraceTreeBuilder({\n        rewriteError: options.rewriteError,\n      });\n\n      // XXX Provide a mechanism to customize this logic.\n      if (http?.headers.get('apollo-federation-include-trace') !== 'ftv1') {\n        return;\n      }\n\n      // If some other (user-written?) plugin already decided that we are not\n      // capturing traces, then we should not capture traces.\n      if (metrics.captureTraces === false) {\n        return;\n      }\n\n      // Note that this will override any `fieldLevelInstrumentation` parameter\n      // to the usage reporting plugin for requests with the\n      // `apollo-federation-include-trace` header set.\n      metrics.captureTraces = true;\n\n      treeBuilder.startTiming();\n\n      return {\n        async executionDidStart() {\n          return {\n            willResolveField({ info }) {\n              return treeBuilder.willResolveField(info);\n            },\n          };\n        },\n\n        async didEncounterErrors({ errors }) {\n          treeBuilder.didEncounterErrors(errors);\n        },\n\n        async willSendResponse({ response }) {\n          // We record the end time at the latest possible time: right before serializing the trace.\n          // If we wait any longer, the time we record won't actually be sent anywhere!\n          treeBuilder.stopTiming();\n\n          // If we're in a gateway, include the query plan (and subgraph traces)\n          // in the inline trace. This is designed more for manually querying\n          // your graph while running locally to see what the query planner is\n          // doing rather than for running in production.\n          if (metrics.queryPlanTrace) {\n            treeBuilder.trace.queryPlan = metrics.queryPlanTrace;\n          }\n\n          const encodedUint8Array = Trace.encode(treeBuilder.trace).finish();\n          const encodedBuffer = Buffer.from(\n            encodedUint8Array,\n            encodedUint8Array.byteOffset,\n            encodedUint8Array.byteLength,\n          );\n\n          const extensions =\n            response.extensions || (response.extensions = Object.create(null));\n\n          // This should only happen if another plugin is using the same name-\n          // space within the `extensions` object and got to it before us.\n          if (typeof extensions.ftv1 !== 'undefined') {\n            throw new Error('The `ftv1` extension was already present.');\n          }\n\n          extensions.ftv1 = encodedBuffer.toString('base64');\n        },\n      };\n    },\n  };\n}\n\n// This plugin does nothing, but it ensures that ApolloServer won't try\n// to add a default ApolloServerPluginInlineTrace.\nexport function ApolloServerPluginInlineTraceDisabled(): InternalApolloServerPlugin {\n  return {\n    __internal_plugin_id__() {\n      return 'InlineTrace';\n    },\n  };\n}\n"]},"metadata":{},"sourceType":"script","externalDependencies":[]}